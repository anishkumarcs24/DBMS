USE EMPLOYEE;

DROP TABLE IF EXISTS INCENTIVES;
DROP TABLE IF EXISTS ASSIGNED_TO;
DROP TABLE IF EXISTS PROJECT;
DROP TABLE IF EXISTS EMPLOYEE;
DROP TABLE IF EXISTS DEPT;

CREATE TABLE DEPT (
    DEPTNO INT PRIMARY KEY,
    DNAME VARCHAR(30),
    DLOC VARCHAR(30)
);

CREATE TABLE EMPLOYEE (
    EMPNO INT PRIMARY KEY,
    ENAME VARCHAR(30),
    MGR_NO INT,
    HIREDATE DATE,
    SAL INT,
    DEPTNO INT,
    FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO),
    FOREIGN KEY (MGR_NO) REFERENCES EMPLOYEE(EMPNO)
);

CREATE TABLE PROJECT (
    PNO INT PRIMARY KEY,
    PLOC VARCHAR(30),
    PNAME VARCHAR(30)
);

CREATE TABLE ASSIGNED_TO (
    EMPNO INT,
    PNO INT,
    JOB_ROLE VARCHAR(30),
    PRIMARY KEY (EMPNO, PNO),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
    FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
    EMPNO INT,
    INCENTIVE_DATE DATE,
    INCENTIVE_AMOUNT INT,
    PRIMARY KEY (EMPNO, INCENTIVE_DATE),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO)
);


INSERT INTO DEPT VALUES
(10,'ACCOUNT','BANGALORE'),
(20,'SALES','MYSORE'),
(30,'IT','DELHI'),
(40,'HR','CHENNAI'),
(50,'FINANCE','MUMBAI');

INSERT INTO EMPLOYEE VALUES
(101,'RAJ',NULL,'2015-01-12',80000,10),
(102,'AMIT',101,'2016-03-20',60000,10),
(103,'NEHA',101,'2017-06-10',55000,20),
(104,'RAVI',102,'2018-07-18',45000,20),
(105,'SONU',103,'2019-11-25',40000,30),
(106,'TINA',103,'2020-01-07',38000,30);

INSERT INTO PROJECT VALUES
(501,'BANGALORE','PAYROLL'),
(502,'DELHI','ERP'),
(503,'MUMBAI','BANKING'),
(504,'CHENNAI','TRAINING'),
(505,'MYSORE','SALES_APP');

INSERT INTO ASSIGNED_TO VALUES
(102,501,'TEAM LEAD'),
(103,502,'DEVELOPER'),
(104,502,'TESTER'),
(105,503,'ANALYST'),
(106,504,'CLERK');

INSERT INTO INCENTIVES VALUES
(102,'2019-01-10',5000),
(103,'2019-01-12',4500),
(104,'2019-01-15',6000),
(105,'2019-01-20',3000),
(106,'2019-01-22',5500);

SELECT E.ENAME AS MANAGER_NAME
FROM EMPLOYEE E
JOIN EMPLOYEE S ON E.EMPNO = S.MGR_NO
GROUP BY E.ENAME
HAVING COUNT(S.EMPNO) = (
    SELECT MAX(cnt)
    FROM (
        SELECT COUNT(MGR_NO) cnt
        FROM EMPLOYEE
        WHERE MGR_NO IS NOT NULL
        GROUP BY MGR_NO
    ) temp
);

SELECT M.ENAME AS MANAGER_NAME
FROM EMPLOYEE M
JOIN EMPLOYEE E ON M.EMPNO = E.MGR_NO
GROUP BY M.EMPNO, M.ENAME, M.SAL
HAVING M.SAL > AVG(E.SAL);

SELECT DISTINCT D.DNAME, M2.ENAME AS SECOND_LEVEL_MANAGER
FROM EMPLOYEE E
JOIN EMPLOYEE M1 ON E.MGR_NO = M1.EMPNO
JOIN EMPLOYEE M2 ON M1.MGR_NO = M2.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO;

SELECT E.ENAME, I.INCENTIVE_AMOUNT
FROM INCENTIVES I
JOIN EMPLOYEE E ON I.EMPNO = E.EMPNO
WHERE I.INCENTIVE_DATE LIKE '2019-01%'
ORDER BY I.INCENTIVE_AMOUNT DESC
LIMIT 1 OFFSET 1;

SELECT E.ENAME
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
WHERE E.DEPTNO = M.DEPTNO;

SELECT E.EMPNO, E.ENAME, D.DNAME AS DEPARTMENT, D.DLOC AS LOCATION
FROM EMPLOYEE E
LEFT JOIN DEPT D ON E.DEPTNO = D.DEPTNO
ORDER BY E.EMPNO;

SELECT E.EMPNO, E.ENAME
FROM EMPLOYEE E
LEFT JOIN ASSIGNED_TO A ON E.EMPNO = A.EMPNO
WHERE A.PNO IS NULL
ORDER BY E.EMPNO;

SELECT P.PNO, P.PNAME, P.PLOC,
       COUNT(A.EMPNO) AS HEADCOUNT
FROM PROJECT P
LEFT JOIN ASSIGNED_TO A ON P.PNO = A.PNO
GROUP BY P.PNO, P.PNAME, P.PLOC
ORDER BY HEADCOUNT DESC, P.PNO;

SELECT D.DEPTNO, D.DNAME,
       ROUND(AVG(E.SAL), 2) AS AVG_SALARY,
       MAX(E.SAL) AS MAX_SALARY
FROM DEPT D
LEFT JOIN EMPLOYEE E ON D.DEPTNO = E.DEPTNO
GROUP BY D.DEPTNO, D.DNAME
ORDER BY D.DEPTNO;

SELECT E.EMPNO, E.ENAME,
       COALESCE(SUM(I.INCENTIVE_AMOUNT), 0) AS TOTAL_INCENTIVES
FROM EMPLOYEE E
LEFT JOIN INCENTIVES I ON E.EMPNO = I.EMPNO
GROUP BY E.EMPNO, E.ENAME
ORDER BY TOTAL_INCENTIVES DESC, E.EMPNO;

SELECT E.EMPNO, E.ENAME, P.PNO, P.PNAME, A.JOB_ROLE
FROM PROJECT P
JOIN ASSIGNED_TO A ON P.PNO = A.PNO
JOIN EMPLOYEE E ON A.EMPNO = E.EMPNO
WHERE P.PNAME = 'Alpha Project'
ORDER BY E.EMPNO;

SELECT D.DEPTNO, D.DNAME, D.DLOC
FROM DEPT D
LEFT JOIN EMPLOYEE E ON D.DEPTNO = E.DEPTNO
WHERE E.EMPNO IS NULL
ORDER BY D.DEPTNO;

SELECT M.EMPNO AS MANAGER_ID, M.ENAME AS MANAGER_NAME,
       COUNT(E.EMPNO) AS DIRECT_REPORTS
FROM EMPLOYEE M
JOIN EMPLOYEE E ON M.EMPNO = E.MGR_NO
GROUP BY M.EMPNO, M.ENAME
ORDER BY DIRECT_REPORTS DESC, M.EMPNO;

SELECT M.EMPNO AS MANAGER_ID, M.ENAME AS MANAGER_NAME,
       COALESCE(COUNT(E.EMPNO), 0) AS DIRECT_REPORTS
FROM EMPLOYEE M
LEFT JOIN EMPLOYEE E ON M.EMPNO = E.MGR_NO
GROUP BY M.EMPNO, M.ENAME
ORDER BY DIRECT_REPORTS DESC, M.EMPNO;

SELECT E.EMPNO, E.ENAME, COUNT(DISTINCT A.PNO) AS PROJECT_COUNT
FROM EMPLOYEE E
JOIN ASSIGNED_TO A ON E.EMPNO = A.EMPNO
GROUP BY E.EMPNO, E.ENAME
HAVING COUNT(DISTINCT A.PNO) > 1
ORDER BY PROJECT_COUNT DESC, E.EMPNO;
